@{
    ViewBag.Title = "Manage Customer Users";
}

<!-- Main bar -->
<div class="mainbar">
    <!-- Matter -->
    <div class="matter">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <div id="objectTable" class="widget wblue">
                        <div class="widget-head">
                            <div class="row">
                                <div class="col-xs-12 col-sm-8 col-md-9 col-lg-9">
                                    <h1>
                                        Пользователи
                                        <span class="error" data-bind="visible: showCountWarning" style="display: none;" 
                                              title="Based on your current subscription package">
                                            <span data-bind="text: count"></span> of <span data-bind="text: maxUsers"></span>
                                        </span>
                                    </h1>
                                </div>
                                <div class="col-xs-12 col-sm-4 col-md-3 col-lg-3">
                                     <button class="btn btn-primary btn-raised pull-right" title="Refresh" data-bind="click: refresh, css: { disabled: isEditing }">
                                            <i class="material-icons">&#xE5D5;</i>
                                    </button>
                                    <button class="btn btn-primary btn-raised pull-right" title="Add new" data-bind="click: showCreateTemplate, css: { disabled: !canAdd() }">
                                        <i class="material-icons">&#xE145;</i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="widget-content manage-table-area">
                            <div class="row">
                                
                                <div class="col-md-12" style="display: none;" data-bind="visible: listErrorMessages().length === 0">
                                     <div class="row head-row hidden-sm hidden-xs">                                     
                                            <div class="col-md-1">Status</div>
                                            <div class="col-md-3">Email</div>
                                            <div class="col-md-2">Name</div>
                                            <div class="col-md-1">Owner</div>
                                            <div class="col-md-1">Admin</div>
                                            <div class="col-md-1">Agent</div>
                                            <div class="col-md-1">Supervisor</div>
                                            <div class="col-md-2"></div>
                                      </div> 
                                      <div data-bind="template: { name: templateToUse, foreach: list }"></div>
                                    
                                </div>

                                <div class="col-md-12" style="display: none;" data-bind="visible: listErrorMessages().length > 0">
                                    <div class="padd statement alert-danger" data-bind="foreach: listErrorMessages">
                                        <h4 class="">User list load error</h4>
                                        <p class="" data-bind="text: $data"></p>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/html" id="rowTmpl">    
    <div class="row hidden-sm hidden-xs">
        <div class="col-md-1" data-bind="attr: { title: statusText() }">
            <i class="material-icons" data-bind="html: (isActive() ? '&#xE7FD;' : '&#xE7FF;')"></i>
        </div>
        <div class="col-md-3" data-bind="text: email"></div>
        <div class="col-md-2" data-bind="text: fullName"></div>
        <div class="col-md-1" >
            <i class="material-icons" data-bind="visible: isOwner">&#xE5CA;</i>
            <i data-bind="visible: !isOwner()">&nbsp;</i>
        </div>
        <div class="col-md-1" >
            <i class="material-icons" data-bind="visible: isAdmin">&#xE5CA;</i>
            <i data-bind="visible: !isAdmin()">&nbsp;</i>
        </div>
        <div class="col-md-1"  data-bind="attr: { title: agentDepartmentNames }">
            <i class="material-icons" data-bind="visible: agentDepartments().length > 0">
                &#xE5CA;
                <span class="table-hint well" data-bind="html: ( agentDepartmentNames )"></span>
            </i>
            <i data-bind="visible: agentDepartments().length == 0">&nbsp;</i>

        </div>
        <div class="col-md-1" data-bind="attr: { title: supervisorDepartmentNames }">
            <i class="material-icons" data-bind="visible: supervisorDepartments().length > 0">&#xE5CA;</i>
            <i data-bind="visible: supervisorDepartments().length == 0">&nbsp;</i>
        </div>
        <div class="col-md-2">
            <div class="btn-group">
                <button class="btn btn-default" title="Edit"
                        data-bind="visible: $root.isUserEditable($data), click: $parent.showEditTemplate, css: { disabled: $parent.isEditing() }">
                    <i class="material-icons">&#xE254;</i>
                </button>
                <button class="btn btn-default" title="Set Password"
                        data-bind="visible: $root.isUserEditable($data), click: $parent.showSetPasswordTemplate, css: { disabled: $parent.isEditing() }">
                    <i class="material-icons">&#xE897;</i>
                </button>
                <button class="btn btn-default" title="Delete"
                        data-bind="visible: $root.isUserDeletable($data), click: $parent.showDeleteTemplate, css: { disabled: $parent.isEditing() }">
                    <i class="material-icons">&#xE14C;</i>
                </button>
            </div>
        </div>
    </div>

    <div class="hidden-lg hidden-md">    
        <div class="row  head-row">
            <div class="col-sm-4 col-xs-4">Name</div>
            <div class="col-sm-8 col-xs-8" data-bind="text: fullName"></div>
        </div>

       <div class="row">
            <div class="col-sm-4 col-xs-4">Status</div>
            <div class="col-sm-8 col-xs-8" data-bind="attr: { title: statusText }">
                <i class="material-icons" data-bind="html: (isActive() ? '&#xE7FD;' : '&#xE7FF;')"></i>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-4 col-xs-4">Email</div>
            <div class="col-sm-8 col-xs-8" data-bind="text: email"></div>
       </div>
        <div class="row">
            <div class="col-sm-4 col-xs-4">Owner</div>
            <div class="col-sm-8 col-xs-8" >
                <i class="material-icons" data-bind="visible: isOwner()">&#xE5CA;</i>
                <i data-bind="visible: !isOwner()">&nbsp;</i>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-4 col-xs-4">Admin</div>
            <div class="col-sm-8 col-xs-8" >
                <i class="material-icons" data-bind="visible: isAdmin()">&#xE5CA;</i>
                <i data-bind="visible: !isAdmin()">&nbsp;</i>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-4 col-xs-4">Agent</div>
            <div class="col-sm-8 col-xs-8"  data-bind="attr: { title: agentDepartmentNames }">
                <i class="material-icons" data-bind="visible: agentDepartments().length > 0">
                    &#xE5CA;
                    <span class="table-hint well" data-bind="html: ( agentDepartmentNames )"></span>
                </i>
                <i data-bind="visible: agentDepartments().length == 0">&nbsp;</i>

            </div>
        </div>
        <div class="row">
            <div class="col-sm-4 col-xs-4">Supervisor</div>
            <div class="col-sm-8 col-xs-8" data-bind="attr: { title: supervisorDepartmentNames }">
                <i class="material-icons" data-bind="visible: supervisorDepartments().length > 0">&#xE5CA;</i>
                <i data-bind="visible: supervisorDepartments().length == 0">&nbsp;</i>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-4 col-xs-4"></div>
            <div class="col-sm-8 col-xs-8">
                <div class="btn-group">
                    <button class="btn btn-default" title="Edit"
                            data-bind="visible: $root.isUserEditable($data), click: $parent.showEditTemplate, css: { disabled: $parent.isEditing() }">
                        <i class="material-icons">&#xE254;</i>
                    </button>
                    <button class="btn btn-default" title="Set Password"
                            data-bind="visible: $root.isUserEditable($data), click: $parent.showSetPasswordTemplate, css: { disabled: $parent.isEditing() }">
                        <i class="material-icons">&#xE897;</i>
                    </button>
                    <button class="btn btn-default" title="Delete"
                            data-bind="visible: $root.isUserDeletable($data), click: $parent.showDeleteTemplate, css: { disabled: $parent.isEditing() }">
                        <i class="material-icons">&#xE14C;</i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</script>

<script type="text/html" id="rowEditTmpl">

        <div class="col-md-12">
            <form autocomplete="false">
                <!-- fake fields are a workaround for chrome autofill getting the wrong fields -->
                <input style="display: none" type="text" name="fakeusernameremembered"/>
                <input style="display: none" type="email" name="fakeuseremailremembered"/>
                <input style="display: none" type="password" name="fakepasswordremembered"/>
                <div class="form-horizontal">
                    <div class="form-group">
                        <label class="col-sm-2 control-label" for="textEmail">Email</label>
                        <div class="col-sm-4">
                            <strong class="text-warning" data-bind="validationMessage: email"></strong>
                            <input type="email" class="form-control" placeholder="Email" id="textEmail" data-bind="textInput: email"/>
                        </div>
                    </div>
                    <div class="form-group" data-bind="visible: (id === 0)">
                        <label class="col-sm-2 control-label" for="textPassword">Password</label>
                        <div class="col-sm-4">
                            <strong class="text-warning" data-bind="validationMessage: password"></strong>
                            <input type="password" class="form-control" placeholder="Password" id="textPassword" autocomplete="new-password" data-bind="textInput: password"/>
                        </div>
                    </div>
                    <div class="form-group" data-bind="visible: (id === 0)">
                        <label class="col-sm-2 control-label" for="textPassword2">&nbsp;</label>
                        <div class="col-sm-4">
                            <strong class="text-warning" data-bind="validationMessage: password2"></strong>
                            <input type="password" class="form-control" placeholder="Repeat Password" id="textPassword2" data-bind="textInput: password2"/>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label" for="textFirstName">First Name</label>
                        <div class="col-sm-4">
                            <strong class="text-warning" data-bind="validationMessage: firstName"></strong>
                            <input type="text" class="form-control" placeholder="First Name" id="textFirstName" data-bind="textInput: firstName"/>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label" for="textLastName">Last Name</label>
                        <div class="col-sm-4">
                            <strong class="text-warning" data-bind="validationMessage: lastName"></strong>
                            <input type="text" class="form-control" placeholder="Last Name" id="textLastName" data-bind="textInput: lastName"/>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-offset-2 col-sm-10">
                            <span class="user-avatar">
                                <img  data-bind="attr: { src: avatarUrl }"/>
                            </span>
                        </div>
                        <label class="col-sm-2 control-label" for="inputFile">Upload Avatar</label>
                        <div class="col-sm-4">
                            <input type="text" readonly="" class="form-control" placeholder="Browse...">
                            <input type="file" id="inputFile" multiple="" data-bind="click: $root.uploadAvatar">
                        </div>
                        <label class="col-sm-1 control-label" for="inputFile">OR </label>
                        <div class="col-sm-2 ">
                            <button class="btn btn-default" data-bind="click: $root.showSelectAvatarDialog">Select one</button>
                        </div>
                    </div>

                    <div class="form-group" data-bind="visible: $parent.currentUser().isOwner()">
                        <div class="col-sm-offset-2 col-sm-4">
                            <div class="checkbox">
                                <label>
                                    <input type="checkbox" class="" data-bind="checked: isOwner"/>
                                    Is Customer Owner
                                </label>
                            </div>
                            <strong class="text-warning" data-bind="validationMessage: isOwner"></strong>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-offset-2 col-sm-4">
                            <div class="checkbox">
                                <label>
                                    <input type="checkbox" class="" data-bind="checked: isAdmin"/>
                                    Is Administrator
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-sm-2 control-label" for="listAgentDepts">Agent For</label>
                        <div class="col-sm-4">
                            <select multiple="multiple" id="listAgentDepts"
                                    data-bind="
                                    options: $root.departments,
                                    optionsText: 'name',
                                    optionsValue: 'id',
                                    selectedOptions: agentDepartments,
                                    multiselect: {}">
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-sm-2 control-label" for="listSupervisorDepts">Supervisor For</label>
                        <div class="col-sm-4">
                            <div>
                                <strong class="text-warning" data-bind="validationMessage: supervisorDepartments"></strong>
                            </div>
                            <select multiple="multiple" id="listSupervisorDepts" data-bind="
                                    options: $root.departments,
                                    optionsText: 'name',
                                    optionsValue: 'id',
                                    selectedOptions: supervisorDepartments,
                                    multiselect: {}">
                            </select>

                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-offset-2 col-sm-4">
                            <div class="checkbox">
                                <label>
                                    <input type="checkbox" class="" data-bind="checked: isDisabled"/>
                                    Is Disabled
                                </label>
                            </div>
                            <strong class="text-warning" data-bind="validationMessage: isDisabled"></strong>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-offset-2 col-sm-4" data-bind="foreach: serverMessages">
                            <strong class="text-warning" data-bind="text: $data"></strong>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-offset-2 col-sm-4">
                            <button class="btn btn-default" data-bind="click: $parent.cancelEdit">Cancel</button>
                            <button class="btn btn-primary" data-bind="click: $parent.create, visible: id == 0">Create</button>
                            <button class="btn btn-primary" data-bind="click: $parent.update,  visible: id > 0">Save</button>

                        </div>
                    </div>
                </div>
            </form>
        </div>

</script>

<script type="text/html" id="rowDeleteTmpl">
    <div class="col-md-12">
            <div class="form-horizontal">
                <div class="form-group">
                    <div class="col-sm-offset-2 col-sm-4">
                        Delete user <span data-bind="text: email"></span>
                        (<span data-bind="text: fullName"></span>)
                    </div>
                </div>
                <div class="form-group">
                    <div class="col-sm-offset-2 col-sm-4">
                        <button class="btn btn-default" data-bind="click: $parent.cancelEdit">Cancel</button>
                        <button class="btn btn-warning" data-bind="click: $parent.delete">Delete</button>

                    </div>
                </div>
            </div>
    </div>
</script>

<script type="text/html" id="rowSetPasswordTmpl">
       <div class="col-md-12">
            <div class="form-horizontal">
                <div class="form-group">
                    <div class="col-sm-offset-2 col-sm-4">
                        Set new Password for user <span data-bind="text: email"></span>
                        (<span data-bind="text: fullName"></span>)
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label" for="textPassword3">&nbsp;</label>
                    <div class="col-sm-4">
                        <strong class="text-warning" data-bind="validationMessage: password"></strong>
                        <input type="password" class="form-control" placeholder="Password" id="textPassword3" autocomplete="off" data-bind="textInput: password"/>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label" for="textPassword4">&nbsp;</label>
                    <div class="col-sm-4">
                        <strong class="text-warning" data-bind="validationMessage: password2"></strong>
                        <input type="password" class="form-control" placeholder="Repeat Password" id="textPassword4" data-bind="textInput: password2"/>
                    </div>
                </div>
                <div class="form-group">
                    <div class="col-sm-offset-2 col-sm-4">
                        <button class="btn btn-default" data-bind="click: $parent.cancelEdit">Cancel</button>
                        <button class="btn btn-primary" data-bind="click: $parent.updatePassword">Set Password</button>
                    </div>
                </div>
            </div>

    </div>
</script>

@Html.Partial("Dialogs/_SelectAvatarDialog")

@section scripts_include {
}

@section scripts{

    <script type="text/javascript">

        var currentUserId = @UserIdentity.GetUserId(User.Identity);

        require(['pages/ManageUsers'],
            function (app)
            {
                $(function ()
                {
                    new app.default(currentUserId).run();
                });
            });

    </script>
}